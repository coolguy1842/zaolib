#include "./Z2.hpp"

template<typename T>
T map(T x, T in_min, T in_max, T out_min, T out_max) {
    return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
}

void printBytes(std::vector<unsigned char> bytes) {
    for(unsigned char byte : bytes) {
        printf("0x%02X ", byte);
    }

    printf("\n");
}


std::vector<unsigned char> Z2::getFlashData(unsigned char commandID) {
    std::vector<unsigned char> buf(17);
    int ret = sendPacket(initialPacket);
    if(ret < 0) { };

    hid_read(device, buf.data(), buf.size());

    ret = sendPacket({
        0x08, UsbCommandID::ReadFlashData, 0x00, 0x00, commandID, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        (unsigned char)(0x3B - commandID)
    });

    if(ret < 0) {
        return { };
    }

    hid_read(device, buf.data(), buf.size());

    std::vector<unsigned char> out(10);
    memmove(out.data(), buf.data() + 6, 10);
    return out;
}


int Z2::setDPIProfile(unsigned char profile) {
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    return sendPacket({
        0x08, WriteFlashData, 0x00, 0x00, 0x04, 0x02, profile, (unsigned char)(0x55 - profile), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xEB
    });
}

int Z2::setDPIProfilesCount(unsigned char count) {
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    ret = sendPacket({
        0x08, WriteFlashData, 0x00, 0x00, 0x02, 0x02, count, (unsigned char)(0x55 - count), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xED
    });

    return ret;
}

int Z2::setProfileDPI(unsigned char profile, unsigned int DPI) {
    if(DPI > 26000) return -2;
    else if(DPI <= 0) return -3;

    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    const unsigned int scaledDPI = std::ceil(DPI / 50.0f) - 1;
    const unsigned char overflowByte = 0x44 * (unsigned char)std::floor(scaledDPI / 256.0f);

    const unsigned char firstByte = (unsigned char)scaledDPI;
    const unsigned char secondByte = (0x55 - overflowByte) - (firstByte * 2);

    const unsigned char profileScaled = profile * 4;
    return sendPacket({
        0x08, WriteFlashData, 0x00, 0x00, (unsigned char)(0x0C + profileScaled), 0x04, firstByte, firstByte, overflowByte, secondByte, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        (unsigned char)(0xE1 - profileScaled)
    });
}

int Z2::setProfileRGBA(unsigned char profile, unsigned char red, unsigned char green, unsigned char blue) {
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    unsigned char verification = 0x55 - (red + green + blue);
    std::vector<unsigned char> data = {
        0x08, WriteFlashData, 0x00, 0x00, (unsigned char)(0x2C + (profile * 4)), 0x04, red, green, blue, verification, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        (unsigned char)(0xC1 - (profile * 4))
    };

    return sendPacket(data);
}


int Z2::setDPILightEffect(DPILightEffect lightEffect) {
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    return sendPacket({
        0x08, WriteFlashData, 0x00, 0x00, 0x52, 0x02, (unsigned char)lightEffect, (unsigned char)(0x55 - lightEffect), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x9D
    });
}

int Z2::setDPILightBrightness(unsigned char brightness) {
    if(brightness < 1) return -2;
    if(brightness > 10) return -3;
    
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    // TODO: should figure this out a better to do this
    std::map<unsigned char, std::pair<unsigned char, unsigned char>> brightnessMap = {
        { 1, std::pair<unsigned char, unsigned char>{0x10, 0x45} },
        { 2, std::pair<unsigned char, unsigned char>{0x1E, 0x37} },
        { 3, std::pair<unsigned char, unsigned char>{0x3C, 0x19} },
        { 4, std::pair<unsigned char, unsigned char>{0x5A, 0xFB} },
        { 5, std::pair<unsigned char, unsigned char>{0x80, 0xD5} },
        { 6, std::pair<unsigned char, unsigned char>{0x96, 0xBF} },
        { 7, std::pair<unsigned char, unsigned char>{0xB4, 0xA1} },
        { 8, std::pair<unsigned char, unsigned char>{0xD2, 0x83} },
        { 9, std::pair<unsigned char, unsigned char>{0xE6, 0x6F} },
        { 10, std::pair<unsigned char, unsigned char>{0xFF, 0x56} }
    };

    auto pair = brightnessMap[brightness];
    return sendPacket({
        0x08, WriteFlashData, 0x00, 0x00, 0x4E, 0x02, pair.first, pair.second, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xA1
    });
}

int Z2::setDPILightFlickerSpeed(unsigned char speed) {
    if(speed < 1) return -2;
    if(speed > 5) return -3;
    
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    return sendPacket({
        0x08, WriteFlashData, 0x00, 0x00, 0x50, 0x02, speed, (unsigned char)(0x55 - speed), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x9F
    });
}


int Z2::setMotionSync(bool enabled) {
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    return sendPacket({
        0x08, WriteFlashData, 0x00, 0x00, 0xAB, 0x02, enabled, (unsigned char)(0x55 - enabled), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x44
    });
}

int Z2::setAngleSnapping(bool enabled) {
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    return sendPacket({
        0x08, WriteFlashData, 0x00, 0x00, 0xAF, 0x02, enabled, (unsigned char)(0x55 - enabled), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x40
    });
}

int Z2::setRippleControl(bool enabled) {
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    return sendPacket({
        0x08, WriteFlashData, 0x00, 0x00, 0xB1, 0x02, enabled, (unsigned char)(0x55 - enabled), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x3E
    });
}


int Z2::setSensorLOD(unsigned char mm) {
    if(mm < 1) return -2;
    else if(mm > 2) return -3;

    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    return sendPacket({
        0x08, WriteFlashData, 0x00, 0x00, 0x0A, 0x02, mm, (unsigned char)(0x55 - mm), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xE5
    });
}

int Z2::setSensorHighPower(bool enabled) {
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    return sendPacket({
        0x08, WriteFlashData, 0x00, 0x00, 0xB9, 0x02, enabled, (unsigned char)(0x55 - enabled), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x36
    });
}

int Z2::setReportRate(ReportRate rate) {
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    if(isWired) {
        switch (rate) {
        case ReportRate::R_2000: case ReportRate::R_4000: return -2;
        default: break;
        }
    }

    return sendPacket({
        0x08, WriteFlashData, 0x00, 0x00, 0x00, 0x02, (unsigned char)rate, (unsigned char)(0x55 - (unsigned char)rate), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xEF
    });
}


int Z2::setLongDistance(bool enabled) {
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;
    
    if(enabled) {
        ret = sendPacket({
            0x08, SetLongRangeMode, 0x00, 0x00, 0x00, 0x0A, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x2C
        });
    }
    else {
        ret = sendPacket({
            0x08, SetLongRangeMode, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x2D
        });
    }

    return ret;
}

int Z2::setPeakPerformance(bool enabled) {
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;
    
    return sendPacket({
        0x08, WriteFlashData, 0x00, 0x00, 0xB5, 0x02, enabled, (unsigned char)(0x55 - enabled), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x3A
    });
}

int Z2::setPeakPerformanceTimer(TimerDurations duration) {
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    std::map<TimerDurations, unsigned char> timerMap = {
        { SECONDS_30, 0x52 },
        { MINUTES_1, 0x4F },
        { MINUTES_5, 0x37 },
        { MINUTES_10, 0x19 },
        { MINUTES_15, 0xFB },
        { MINUTES_20, 0xDD },
        { MINUTES_25, 0xBF },
        { MINUTES_30, 0xA1 },
        { MINUTES_35, 0x83 },
        { MINUTES_40, 0x65 }
    };

    return sendPacket({
        0x08, WriteFlashData, 0x00, 0x00, 0xB7, 0x02, (unsigned char)duration, timerMap[duration], 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x38
    });
}


int Z2::getProfile() {
    auto data = getFlashData(0x04);
    if(data.size() <= 0) return -1;
    
    return data[0];
}

int Z2::getProfileCount() {
    auto data = getFlashData(0x02);
    if(data.size() <= 0) return -1;
    
    return data[0];
}

Z2::ReportRate Z2::getReportRate() {
    auto data = getFlashData(0x00);
    if(data.size() <= 0) return Z2::ReportRate::R_INVALID;
    
    return (ReportRate)data[0];
}


int Z2::getBatteryPercentage() {
    // 100%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x64 0x00 0x10 0x72 0x00 0x00 0x00 0x00 0x00 0x00 0x61

    // 94%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x5A 0x00 0x0F 0xEC 0x00 0x00 0x00 0x00 0x00 0x00 0xF2

    // 93%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x5A 0x00 0x0F 0xE8 0x00 0x00 0x00 0x00 0x00 0x00 0xF6

    // 92%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x5A 0x00 0x0F 0xE3 0x00 0x00 0x00 0x00 0x00 0x00 0xFB

    // 90%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x5A 0x00 0x0F 0xDF 0x00 0x00 0x00 0x00 0x00 0x00 0xFF

    // 88% (maybe)
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x55 0x00 0x0F 0xD7 0x00 0x00 0x00 0x00 0x00 0x00 0x0C

    // 87%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x55 0x00 0x0F 0xD3 0x00 0x00 0x00 0x00 0x00 0x00 0x10
    
    // 57%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x37 0x00 0x0F 0x5E 0x00 0x00 0x00 0x00 0x00 0x00 0xA3

    // 53%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x37 0x00 0x0F 0x45 0x00 0x00 0x00 0x00 0x00 0x00 0xBC

    // 51%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x32 0x00 0x0F 0x34 0x00 0x00 0x00 0x00 0x00 0x00 0xD2

    // 48%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x32 0x00 0x0F 0x1F 0x00 0x00 0x00 0x00 0x00 0x00 0xE7

    // 46%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x32 0x00 0x0F 0x12 0x00 0x00 0x00 0x00 0x00 0x00 0xF4

    // 35%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x23 0x00 0x0E 0xB6 0x00 0x00 0x00 0x00 0x00 0x00 0x60

    // 26%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x1E 0x00 0x0E 0x5F 0x00 0x00 0x00 0x00 0x00 0x00 0xBC
    
    // 23%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x19 0x00 0x0E 0x39 0x00 0x00 0x00 0x00 0x00 0x00 0xE7
    
    // 21%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x19 0x00 0x0E 0x28 0x00 0x00 0x00 0x00 0x00 0x00 0xF8

    // 16%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x0F 0x00 0x0D 0xE1 0x00 0x00 0x00 0x00 0x00 0x00 0x4A

    // 10%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x0A 0x00 0x0D 0x9A 0x00 0x00 0x00 0x00 0x00 0x00 0x96

    // 6%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x05 0x00 0x0D 0x6C 0x00 0x00 0x00 0x00 0x00 0x00 0xC9

    // 4%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x05 0x00 0x0D 0x53 0x00 0x00 0x00 0x00 0x00 0x00 0xE2 

    // 0%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x05 0x00 0x0C 0x7A 0x00 0x00 0x00 0x00 0x00 0x00 0xBC


    // charging (indicated by 0x01 instead of 0x00 between the two shorts)
    
    // 100%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x64 0x01 0x10 0x72 0x00 0x00 0x00 0x00 0x00 0x00 0x60

    // 77%
    // 0x08 0x04 0x00 0x00 0x00 0x02 0x4B 0x01 0x0F 0xA9 0x00 0x00 0x00 0x00 0x00 0x00 0x43


    // untested but might work
    return map((int)getBatteryCharge(), 0x0C7A, 0x1072, 0, 100);

    std::vector<unsigned char> buf(17);
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    hid_read(device, buf.data(), buf.size());

    ret = sendPacket({
        0x08, BatteryLevel, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x49
    });

    if(ret < 0) {
        return ret;
    }

    hid_read(device, buf.data(), buf.size());
    printBytes(buf);

    return buf[6];
}

short Z2::getBatteryCharge() {
    std::vector<unsigned char> buf(17);
    int ret = sendPacket(initialPacket);
    if(ret < 0) return ret;

    hid_read(device, buf.data(), buf.size());

    ret = sendPacket({
        0x08, BatteryLevel, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x49
    });

    if(ret < 0) {
        return ret;
    }

    hid_read(device, buf.data(), buf.size());
    printBytes(buf);
    return (short)(buf[8] << 8) + buf[9];
}


Z2* findZ2() {
    hid_device_info* devices = hid_enumerate(0x3554, 0);
    
    if(devices) {
        unsigned int PID = devices->product_id;
        hid_free_enumeration(devices);

        return new Z2(PID);
    }

    return nullptr;
}